<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" content="{{_csrf.token}}">
    <meta name="_csrf_header" content="{{_csrf.headerName}}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/user/css/common.css">
    <link rel="stylesheet" href="/user/css/main.css">
    <!-- <script src="/user/js/main.js"></script> -->
    <title>ë©”ì¸</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>

<body>
    <header>
        <div class="logo">
            <img src="/user/images/logo.png" alt="CoreNet">
        </div>
        <div data-position="{{loginUser.role}}">
            <form action="/adminuser" method="get" class="isAdmin" style="display:inline;">
                <button type="submit" class="adminBtn">ê´€ë¦¬ì</button>
            </form>
            <form action="/logout" method="post" style="display:inline;">
                <input type="hidden" name="_csrf" value="{{_csrf.token}}">
                <button type="submit" class="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
        </div>
    </header>

    <main>
        {{> fragments/usernav}}

        <div class="main-view">
            <section>
                <div>
                    <h1>ì¸íŠ¸ë¼ë„·</h1>
                </div>
                <div class="user-info">
                    <div data-jocode="{{loginUser.jobcode}}"><strong>ì‚¬ìš©ì:&nbsp;</strong>{{loginUser.userName}} ë‹˜</div>
                    <div><strong>ë¡œê·¸ì¸ ì‹œê°„:&nbsp;</strong>{{loginUser.loginDateTime}}</div>
                    <!-- <a href="/user-mypage">ë§ˆì´í˜ì´ì§€</a> -->
                </div>
            </section>

            <!-- ì£¼ìš” ê³µì§€ì‚¬í•­ -->
            <section class="notice-section">
                <h2>ğŸ“¢ ì£¼ìš” ê³µì§€ì‚¬í•­</h2>
                <ul>
                    {{#noticeList}}
                    <li>
                        <strong>{{createdAtFormatted}}</strong>: {{title}} - {{content}}
                    </li>
                    {{/noticeList}}
                    {{^noticeList}}
                    <li>ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                    {{/noticeList}}
                </ul>
            </section>

            <!-- ë¹ ë¥¸ ë©”ë‰´ -->
            <section class="quick-menu">
                <a href="#" class="menu-approved">
                    <div>ê²°ì¬ì™„ë£Œ</div>
                    <div id="approval-count"></div>
                </a>
                <a href="#" class="menu-draft">
                    <div>ì„ì‹œì €ì¥</div>
                    <div id="draft-count"></div>
                </a>
                <a href="#" class="menu-rejected">
                    <div>ê²°ì¬ë°˜ë ¤</div>
                    <div id="rejected-count"></div>
                </a>
                <a href="#" class="menu-pending">
                    <div>ê²°ì¬ëŒ€ê¸°</div>
                    <div id="pending-count">3ê°œ</div>
                </a>
            </section>

            <section class="carousel-map-section">
                <!-- ìºëŸ¬ì…€ -->
                <div class="carousel">
                    <button class="nav prev">â€¹</button>
                    <div class="carousel-track-container">
                        <ul class="carousel-track">
                            {{#todayUsers}}
                            <li class="carousel-slide">
                                <strong>{{userName}}</strong><br>
                                <span>{{companyEmail}}</span><br>
                                <small>Dept: {{todayDepartmentName}}</small>
                            </li>
                            {{/todayUsers}}
                        </ul>
                    </div>
                    <button class="nav next">â€º</button>
                </div>

                <!-- ì§€ë„ -->
                <div id="map"></div>
            </section>


        </div>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const track = document.querySelector('.carousel-track');
            const slides = Array.from(track.children);
            const nextBtn = document.querySelector('.next');
            const prevBtn = document.querySelector('.prev');

            if (!nextBtn || !prevBtn) {
                console.error("Carousel buttons not found");
                return;
            }

            let currentIndex = 0;

            function updateSlide() {
                const slideWidth = slides[0].getBoundingClientRect().width;
                track.style.transform = `translateX(-${slideWidth * currentIndex}px)`;
            }

            // ë²„íŠ¼ í´ë¦­
            nextBtn.addEventListener('click', () => {
                currentIndex = (currentIndex + 1) % slides.length;
                updateSlide();
            });

            prevBtn.addEventListener('click', () => {
                currentIndex = (currentIndex - 1 + slides.length) % slides.length;
                updateSlide();
            });

            // ìë™ ì´ë™
            const AUTO_SLIDE_INTERVAL = 3000; // 3ì´ˆë§ˆë‹¤ ì´ë™
            setInterval(() => {
                currentIndex = (currentIndex + 1) % slides.length;
                updateSlide();
            }, AUTO_SLIDE_INTERVAL);

            // ì§€ë„ ìƒì„±
            const map = L.map('map').setView([37.5665, 126.9780], 13); // ì„œìš¸ (ìœ„ë„, ê²½ë„)

            // OpenStreetMap íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // ë§ˆì»¤ ì¶”ê°€ (ì„œìš¸ ì‹œì²­ì— ë§ˆì»¤ë¥¼ ì¶”ê°€)
            const marker = L.marker([37.5665, 126.9780]).addTo(map);
            marker.bindPopup("<b>ì„œìš¸ ì‹œì²­</b>").openPopup();

            // ì „ìê²°ì¬ ìƒíƒœ
            function fetchStatusData() {
                const jobcode = document.querySelector('[data-jocode]').getAttribute('data-jocode');

                fetch(`/count-doc-status?jobcode=${jobcode}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if(data.systemAdmin){
                            document.querySelector(".quick-menu").style.display = 'none'; 
                        }else{
                            document.getElementById('approval-count').textContent = `${data.approved}ê°œ`;

                            // draft-count ì¡°ê±´ ì²˜ë¦¬
                            const draftMenu = document.querySelector('.menu-draft');
                            if (!data.approver) {
                                // approverê°€ ì—†ìœ¼ë©´ draft-count í‘œì‹œ
                                document.getElementById('draft-count').textContent = `${data.draft}ê°œ`;
                                draftMenu.hidden = false;  // draft ë©”ë‰´ ë³´ì´ê¸°
                            } else {
                                // approverê°€ ìˆìœ¼ë©´ draft-count ìˆ¨ê¹€
                                draftMenu.hidden = true;  // draft ë©”ë‰´ ìˆ¨ê¸°ê¸°
                            }

                            // ê±°ì ˆ, ëŒ€ê¸° ì¹´ìš´íŠ¸ í‘œì‹œ
                            document.getElementById('rejected-count').textContent = `${data.rejected}ê°œ`;  
                            document.getElementById('pending-count').textContent = `${data.pending}ê°œ`;
                        }

                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
            }

            fetchStatusData();  

        });

    </script>

    <script src="/user/js/common.js"></script>

</body>

</html>