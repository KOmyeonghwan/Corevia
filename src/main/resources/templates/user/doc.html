<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" content="{{_csrf.token}}">
  <meta name="_csrf_header" content="{{_csrf.headerName}}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/user/css/common.css">
  <link rel="stylesheet" href="/user/css/doc.css">

  <script src="/user/js/doc.js"></script>

  <title>ì „ìê²°ì¬ </title>
</head>

<body>
  <!-- document approval(CKeditor5) -->
  <header>
    <div class="logo">
      <img src="/user/images/logo.png" alt="CoreNet">
    </div>
    <div>
      {{loginUser.userName}} ë‹˜
    </div>
  </header>

  <main>
    {{> fragments/usernav}}

    <div class="main-view">
      <section class="quick-menu">
        {{#docs}}
        <button data-doc-code="{{docCode}}" class="menu-approval">{{docName}}</button>
        {{/docs}}
      </section>

      <section>
        <div class="tabs">
          <div class="tab active" data-tab="approved">ê²°ì¬ì™„ë£Œ</div>
          <div class="tab" data-tab="draft">ì„ì‹œì €ì¥</div>
          <div class="tab" data-tab="rejected">ê²°ì¬ë°˜ë ¤</div>
          <div class="tab" data-tab="pending">ê²°ì¬ëŒ€ê¸°</div>
        </div>

        <button id="open-compose" onclick="location.href='/userdocedit'">ë¬¸ì„œ ì“°ê¸°</button>

        <div class="board-view">
          <div id="content-1" class="tab-content">
            <table>
              <thead>
                <tr>
                  <th>ë¬¸ì„œë²ˆí˜¸</th>
                  <th>ì œëª©</th>
                  <th>ì‘ì„±ì</th>
                  <th>ì‘ì„±ì¼</th>
                </tr>
              </thead>
              <tbody id="docTableBody">

              </tbody>
            </table>

            <div id="pagination"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      let currentPage = 1;
      const pageSize = 10;
      let currentStatus = 'APPROVED';
      let currentDocType = null;

      const statusMap = {
        approved: 'APPROVED',
        draft: 'DRAFT',
        rejected: 'REJECTED',
        pending: 'PENDING'
      };

      // ë¬¸ì„œ ë²„íŠ¼
      document.querySelectorAll('.menu-approval').forEach(btn => {
        btn.addEventListener('click', () => {
          currentDocType = btn.dataset.docCode;
          currentPage = 1;
          console.log('ğŸ“„ docType =', currentDocType);
          loadDocs();
        });
      });

      // íƒ­ í´ë¦­
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          currentStatus = statusMap[tab.dataset.tab];
          currentPage = 1;

          console.log('ğŸŸ© status =', currentStatus);
          loadDocs();
        });
      });

      // âœ… ì´ˆê¸° ìë™ ì„ íƒ (ì—¬ê¸°ê°€ í•µì‹¬)
      const defaultDocBtn = document.querySelector('.menu-approval[data-doc-code="draft"]');
      const defaultTab = document.querySelector('.tab[data-tab="approved"]');

      if (defaultDocBtn && defaultTab) {

        // âœ… ê¸°ì¡´ í™œì„±í™” ì „ë¶€ ì œê±°
        document.querySelectorAll('.menu-approval.active')
          .forEach(btn => btn.classList.remove('active'));

        document.querySelectorAll('.tab.active')
          .forEach(tab => tab.classList.remove('active'));

        // âœ… ê¸°ë³¸ê°’ í™œì„±í™”
        defaultTab.classList.add('active');
        defaultDocBtn.classList.add('active');

        // docType ì„¤ì • + ëª©ë¡ ë¡œë”©
        currentDocType = defaultDocBtn.dataset.docCode;
        currentStatus = statusMap[defaultTab.dataset.tab];
        currentPage = 1;

        loadDocs();
      }

      function loadDocs() {
        if (!currentDocType) return;

        fetch(`/userdoc/ajax?docType=${currentDocType}&page=${currentPage}&pageSize=${pageSize}&status=${currentStatus}`)
          .then(res => res.json())
          .then(data => {
            renderTable(data.doclist);
            updatePagination(data.currentPage, data.totalPages);
          })
          .catch(console.error);
      }

      function renderTable(doclist) {
        const tbody = document.getElementById("docTableBody");
        tbody.innerHTML = "";

        if (!doclist || doclist.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
          return;
        }

        console.log("currentStatus =", currentStatus);


        doclist.forEach(doc => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>
              <a href="/userdocdetail/${doc.docId}?docType=${currentDocType}&status=${currentStatus}">
                ${doc.docNo}
              </a>
            </td>
            <td>
              <a href="/userdocdetail/${doc.docId}?docType=${currentDocType}&status=${currentStatus}">
                ${doc.detailTitle}
              </a>
            </td>
            <td>${doc.writer}</td>
            <td>${doc.writeDate}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function updatePagination(current, total) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        for (let i = 1; i <= total; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          if (i === current) btn.classList.add("active");
          btn.onclick = () => {
            currentPage = i;
            loadDocs();
          };
          pagination.appendChild(btn);
        }
      }
    });
  </script>


  <script src="/user/js/common.js"></script>
</body>

</html>