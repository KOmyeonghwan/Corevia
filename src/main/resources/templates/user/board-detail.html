<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <meta name="_csrf" content="{{_csrf.token}}">
    <meta name="_csrf_header" content="{{_csrf.headerName}}">
    <link rel="stylesheet" href="/user/css/common.css">
    <link rel="stylesheet" href="/user/css/board-detail.css">
    <script src="/user/js/board-detail.js"></script>

    <title>board</title>
</head>

<body>
    <header>
        <div class="logo">
            <img src="/user/images/logo.png" alt="CoreNet">
        </div>
        <div data-position="{{loginUser.role}}">
            {{loginUser.userName}} 님
            <form action="/adminuser" method="get" class="isAdmin" style="display:inline;">
                <button type="submit" class="adminBtn">관리자</button>
            </form>
            <form action="/logout" method="post" style="display:inline;">
                <input type="hidden" name="_csrf" value="{{_csrf.token}}">
                <button type="submit" class="logoutBtn">로그아웃</button>
            </form>
            
            
        </div>
    </header>

    <main>
        {{> fragments/usernav}}

        <div class="main-view">
            <div class="post-detail">

                <h2 class="post-title">제목 : {{post.title}}</h2>

                <div class="post-meta">
                    <span class="author">작성자: {{post.userName}}</span>
                    <span class="date">작성일: {{post.createAtFormatted}}</span>
                    <span class="views">조회수: {{post.views}}</span>
                </div>

                <div class="post-content">
                    {{{post.content}}}
                </div>

                {{#post.fileUrl}}
                <div class="post-attachments">
                    <strong>첨부파일:</strong>
                    <ul>
                        <li>
                            <a href="/user/board/{{boardCode}}/{{boardId}}/attachment" 
                                download="{{post.fileName}}">
                                {{post.fileName}}
                            </a>
                        </li>
                    </ul>
                </div>
                {{/post.fileUrl}}


                <!-- 댓글창 -->
                <div class="chat-box hidden">
                    <div class="close-compose">X</div>

                    <!-- 댓글 리스트는 JS에서 렌더링 -->

                    <!-- 입력창 -->
                    <form action="" class="chat-input">
                        <input type="hidden" name="{{_csrf.parameterName}}" value="{{_csrf.token}}">

                        <input type="text" class="chat-text" placeholder="댓글을 입력하세요…" />
                        <button class="chat-submit">등록</button>
                    </form>
                </div>

                <!-- 하단 버튼 -->
                <div class="post-actions">
                    <button class="btn-comments">
                        댓글보기
                    </button>

                    <button class="btn-list" onclick="location.href='/userboard'">목록</button>

                    {{#isAuthor}}
                    <button class="btn-edit"
                        onclick="location.href='/userboarddetailedit/{{post.boardCode}}/{{post.id}}'">
                        수정
                    </button>

                    <button class="btn-delete" data-id="{{post.id}}" data-board="{{post.boardCode}}">
                        삭제
                    </button>
                    {{/isAuthor}}


                </div>
            </div>
        </div>




        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const boardCode = "{{post.boardCode}}";
                const postId = "{{post.id}}";

                // 댓글창 버튼 활성화
                const openBtn = document.querySelector(".btn-comments");

                // 댓글창과 닫기 버튼
                const closeBtn = document.querySelector(".close-compose");
                const boardChatBox = document.querySelector(".chat-box");

                // 수정 버튼
                const editBtn = document.querySelector(".btn-edit");

                openBtn.addEventListener("click", () => {
                    boardChatBox.classList.remove("hidden"); 
                });

                closeBtn.addEventListener("click", () => {
                    boardChatBox.classList.add("hidden"); 
                });


                // 페이지 로딩 시 댓글 불러오기
                loadComments(boardCode, postId);

                // 최상위 댓글 등록 이벤트
                document.querySelector(".chat-input").addEventListener("submit", function (e) {
                    e.preventDefault();
                    const textInput = this.querySelector(".chat-text");
                    const text = textInput.value.trim();
                    if (!text) { alert("댓글을 입력하세요."); return; }

                    addComment(boardCode, postId, text, null, 0, () => {
                        textInput.value = "";
                        loadComments(boardCode, postId);
                    });
                });
            });

            /** ============================
             * 댓글/답글 추가 함수
             * @param parentId : 부모 댓글 ID (null이면 최상위 댓글)
             * @param depth : 0=댓글, 1=대댓글, 2=2단 댓글
             */
            function addComment(boardCode, postId, content, parentId, depth, callback) {
                const params = new URLSearchParams();
                params.append("content", content);
                if (parentId) params.append("parentId", parentId);
                params.append("depth", depth);

                // 로그인한 유저의 부서 코드 가져오기
                const deptCode = "{{loginUser.department_id}}";
                params.append("deptCode", deptCode);

                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

                fetch(`/userboard/comment/${boardCode}/${postId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        [csrfHeader]: csrfToken
                    },
                    body: params.toString()
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === "success") callback();
                        else alert(data.message);
                    })
                    .catch(err => { console.error(err); alert("댓글 등록 중 오류 발생"); });
            }

            /** ============================
             * 댓글 불러오기
             */
            function loadComments(boardCode, postId) {
                fetch(`/userboard/comments/${boardCode}/${postId}`)
                    .then(res => res.json())
                    .then(comments => renderComments(comments))
                    .catch(err => console.error("댓글 불러오기 오류:", err));
            }

            /** ============================
             * 댓글 렌더링 (트리 구조)
             */
            function renderComments(comments) {
                const chatBox = document.querySelector(".chat-box");
                const inputForm = chatBox.querySelector(".chat-input");

                // 기존 댓글 제거
                [...chatBox.querySelectorAll(".chat-item")].forEach(e => e.remove());


                if (!comments || comments.length === 0) {
                    // 댓글 없으면 메시지 표시
                    const emptyDiv = document.createElement("div");
                    emptyDiv.classList.add("chat-item");
                    emptyDiv.innerHTML = `<div class="no-comments">댓글이 없습니다.</div>`;
                    chatBox.insertBefore(emptyDiv, inputForm);
                    return;
                }

                // 댓글 map 생성
                const commentMap = {};
                comments.forEach(c => commentMap[c.id] = { ...c, children: [] });

                // 부모-자식 구조 생성
                const roots = [];
                comments.forEach(c => {
                    if (c.parentId) {
                        commentMap[c.parentId]?.children.push(commentMap[c.id]);
                    } else {
                        roots.push(commentMap[c.id]);
                    }
                });

                // 트리 구조 재귀 렌더링
                roots.forEach(c => {
                    const el = createCommentElement(c);
                    chatBox.insertBefore(el, inputForm);
                });
            }

            /** ============================
             * 재귀적으로 댓글 HTML 생성
             */
            function createCommentElement(comment) {
                const div = document.createElement("div");
                div.classList.add("chat-item");
                div.dataset.commentId = comment.id;
                div.dataset.commentDepth = comment.depth;

                let depthClass = "";
                if (comment.depth === 1) depthClass = "second-chat";
                else if (comment.depth === 2) depthClass = "third-chat";

                div.innerHTML = `
                    <div class="${depthClass || "main-chat"}">
                        <div class="chat-header">
                            <span class="author">${comment.userName}</span>
                            <span class="time">${comment.createAtFormatted}</span>
                        </div>
                        <div class="chat-content">${comment.content}</div>
                        ${comment.depth < 2 ? '<div class="reply-btn">답글</div>' : ''}
                    </div>
                `;

                // 자식 댓글 재귀적 추가
                comment.children.forEach(child => {
                    const childEl = createCommentElement(child);
                    div.appendChild(childEl);
                });

                return div;
            }

            /** ============================
             * 답글 버튼 클릭 이벤트
             */
            document.addEventListener("click", function (e) {
                if (!e.target.classList.contains("reply-btn")) return;

                const parentChat = e.target.closest(".chat-item");
                if (!parentChat) return;

                // 이미 답글 입력창이 있으면 무시
                if (parentChat.querySelector(".reply-input")) return;

                const replyInput = document.createElement("div");
                replyInput.classList.add("reply-input");
                replyInput.innerHTML = `
                    <input type="text" class="chat-text" placeholder="답글을 입력하세요…" />
                    <button class="chat-submit">등록</button>
                `;
                parentChat.appendChild(replyInput);

                replyInput.querySelector(".chat-submit").addEventListener("click", function () {
                    const text = replyInput.querySelector(".chat-text").value.trim();
                    if (!text) { alert("답글을 입력하세요."); return; }

                    const boardCode = "{{post.boardCode}}";
                    const postId = "{{post.id}}";
                    const parentId = parentChat.dataset.commentId;
                    const depth = parseInt(parentChat.dataset.commentDepth) + 1;

                    addComment(boardCode, postId, text, parentId, depth, () => {
                        loadComments(boardCode, postId); // 전체 리로드
                    });
                });

            });

            // 게시글 삭제
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (!confirm("정말 삭제하시겠습니까?")) return;

                    const postId = btn.dataset.id;
                    const boardCode = btn.dataset.board;

                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

                    try {
                        const res = await fetch(`/post/${postId}?boardCode=${boardCode}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                                [csrfHeader]: csrfToken
                            }
                        });

                        if (res.ok) {
                            alert('삭제 성공');
                            window.location.href = '/userboard';
                        } else {
                            const msg = await res.text();
                            alert('삭제 실패: ' + msg);
                        }
                    } catch (err) {
                        alert('삭제 중 오류 발생: ' + err);
                    }
                });
            });
        </script>

    </main>

    <script src="/user/js/common.js"></script>

</body>

</html>