<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" content="{{_csrf.token}}">
    <meta name="_csrf_header" content="{{_csrf.headerName}}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/user/css/common.css">
    <link rel="stylesheet" href="/user/css/user-mypage.css">

    <title>ë§ˆì´í˜ì´ì§€</title>
</head>


<body>
    <header>
        <div class="logo">
            <img src="/user/images/logo.png" alt="CoreNet">
        </div>
        <div data-position="{{loginUser.positionLevel}}">
            {{loginUser.userName}} ë‹˜
            <form action="/adminuser" method="get" class="isAdmin" style="display:inline;">
                <button type="submit" class="adminBtn">ê´€ë¦¬ì</button>
            </form>
            <form action="/logout" method="post" style="display:inline;">
                <input type="hidden" name="_csrf" value="{{_csrf.token}}">
                <button type="submit" class="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
        </div>
    </header>

    <main>
        {{> fragments/usernav}}

        <div class="main-view">
            <div class="my-page-title">
                <h2>ë§ˆì´í˜ì´ì§€</h2>
            </div>
            <div class="card">
                <div class="card-face">
                    <i class="fa-solid fa-circle-user"></i>
                </div>
                <div class="profile-info">
                    <h2 class="profile-name">{{loginUser.userName}}</h2>
                    <div class="profile-meta">
                        <span>{{loginUser.departmentName}}</span>
                        <span class="divider">|</span>
                        <span>{{loginUser.positionTitle}}</span>
                    </div>
                </div>
            </div>

            <div class="card-list">
                <div class="card-show">
                    <h2>ë‚´ê°€ ì“´ ê²Œì‹œê¸€</h2>
                    <p>{{postCount}}</p>
                </div>

                <div class="card-show">
                    <h2>ë‚´ê°€ ì“´ ëŒ“ê¸€</h2>
                    <p>{{commentCount}}</p>
                </div>

                <div class="card-show">
                    <h2>ì „ìê²°ì¬</h2>
                    <p>{{docCount}}</p>
                </div>
            </div>

            <div class="privacy-change">
                <div class="privacy-form">
                    <h2 class="privacy-title">ê°œì¸ì •ë³´ ìˆ˜ì •</h2>

                    <div class="form-group">
                        <label>ğŸ”’ ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="newPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                    </div>

                    <div class="form-group">
                        <label>ğŸ”’ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="confirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“§ ì´ë©”ì¼</label>
                        <input type="email" id="email" value="{{loginUser.email}}" placeholder="ì´ë©”ì¼ ì…ë ¥">
                    </div>

                    <div class="privacy-btns">
                        <button class="privacy-btn" onclick="changePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                        <button class="privacy-btn" onclick="changeEmail()">ì´ë©”ì¼ ë³€ê²½</button>
                    </div>

                </div>
            </div>


        </div>

    </main>


    <script src="/user/js/common.js"></script>


    <script>
        function isValidPassword(password) {
            const regex = /^(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{6,50}$/;
            return regex.test(password);
        }


        function changePassword() {
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;

            if (!newPassword || !confirmPassword) {
                alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (newPassword !== confirmPassword) {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            // â­ ë¹„ë°€ë²ˆí˜¸ ì •ì±… ê²€ì‚¬
            if (!isValidPassword(newPassword)) {
                alert(
                    "ë¹„ë°€ë²ˆí˜¸ëŠ” 6~50ìì´ë©°\n" +
                    "ëŒ€ë¬¸ì 1ê°œ ì´ìƒ, íŠ¹ìˆ˜ë¬¸ì 1ê°œ ì´ìƒì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤."
                );
                return;
            }

            const csrfToken = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            fetch("/user/mypage/password", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    newPassword: newPassword
                })
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        location.reload();
                    }
                });
        }

        function changeEmail() {
            const email = document.getElementById("email").value;

            if (!email) {
                alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const csrfToken = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            fetch("/user/mypage/email", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ email })
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        location.reload();
                    }
                });
        }
    </script>


</body>

</html>