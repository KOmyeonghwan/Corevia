<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <meta name="_csrf" content="{{_csrf.token}}">
  <meta name="_csrf_header" content="{{_csrf.headerName}}">
  <link rel="stylesheet" href="/user/css/common.css">
  <link rel="stylesheet" href="/user/css/board.css">
  <script src="/user/js/board.js"></script>

  <title>board</title>
</head>

<body>
  <header>
    <div class="logo">
      <img src="/user/images/logo.png" alt="CoreNet">
    </div>
    <div data-position="{{loginUser.positionLevel}}">
      {{loginUser.userName}} 님
      <form action="/adminuser" method="get" class="isAdmin" style="display:inline;">
        <button type="submit" class="adminBtn">관리자</button>
      </form>
      <form action="/logout" method="post" style="display:inline;">
        <input type="hidden" name="_csrf" value="{{_csrf.token}}">
        <button type="submit" class="logoutBtn">로그아웃</button>
      </form>

    </div>
  </header>

  <main>
    {{> fragments/usernav}}

    <div class="main-view">
      <div class="tabs">
        {{#boards}}
        <div class="tab" data-tab="{{boardCode}}">
          {{boardName}}
        </div>
        {{/boards}}
      </div>

      <div id="boardUserContent" class="board-view">
        <!-- 여기서 데이터 보여줌 -->
      </div>

      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const tabs = document.querySelectorAll(".tabs .tab");
          const boardContent = document.getElementById('boardUserContent');

          let currentBoardCode = null;
          let currentPage = 1;
          const pageSize = 10;

          /* ================= 게시판 로딩 ================= */
          async function loadBoard(boardCode, page = 1) {
            const response = await fetch(
              `/userboard/board/${boardCode}?page=${page}&size=${pageSize}`
            );
            const html = await response.text();
            boardContent.innerHTML = html;
          }

          /* ================= 탭 클릭 ================= */
          tabs.forEach(tab => {
            tab.addEventListener("click", () => {
              tabs.forEach(t => t.classList.remove("active"));
              tab.classList.add("active");

              currentBoardCode = tab.dataset.tab;
              currentPage = 1;

              loadBoard(currentBoardCode, currentPage);
            });
          });

          /* ================= 페이지 버튼 클릭 ================= */
          boardContent.addEventListener('click', (e) => {
            const pageBtn = e.target.closest('.page-btn');
            if (!pageBtn) return;

            const page = Number(pageBtn.dataset.page);
            if (!page || page === currentPage) return;

            currentPage = page;
            loadBoard(currentBoardCode, currentPage);
          });

          /* ================= 초기 게시판 ================= */
          const defaultBoardCode = 'notice';
          const defaultTab = [...tabs].find(tab => tab.dataset.tab === defaultBoardCode);

          if (defaultTab) {
            defaultTab.classList.add("active");
            currentBoardCode = defaultBoardCode;
            loadBoard(defaultBoardCode, currentPage);
          } else if (tabs.length > 0) {
            tabs[0].classList.add("active");
            currentBoardCode = tabs[0].dataset.tab;
            loadBoard(currentBoardCode, currentPage);
          }
        });
      </script>

      <button id="open-compose">게시글 쓰기</button>
    </div>
  </main>


  <!-- 모달 창 -->
  <div id="composeModal" class="compose-modal hidden">
    <div class="modal-content">
      <form action="/userboard/post" method="post" enctype="multipart/form-data">
        <input type="hidden" name="{{_csrf.parameterName}}" value="{{_csrf.token}}">

        <h2>게시글 쓰기</h2>

        <select name="boardCode" required>
          <option value="" disabled>카테고리 선택</option>
          {{#boards}}
          <option value="{{boardCode}}">{{boardName}}</option>
          {{/boards}}
        </select>

        <input type="text" name="title" placeholder="제목" required />

        <textarea name="content" placeholder="내용을 입력하세요..." required></textarea>

        <input type="hidden" name="id" value="{{loginUser.userPk}}">
        <input type="hidden" name="userName" value="{{loginUser.userName}}">
        <input type="hidden" name="deptCode" value="{{loginUser.department_id}}">
        <input type="hidden" name="positionLevel" value="{{loginUser.positionLevel}}">

        <input type="file" name="boardFile">

        <div class="modal-actions">
          <button type="submit" id="send-mail">작성</button>
          <button type="button" id="close-compose">닫기</button>
        </div>
      </form>
    </div>
  </div>

  <footer>
    <p>프로젝트명: corevia | 주소: https://github.com/KOmyeonghwan | 팀명: 9k9k / 팀원: 고명환(기획자), 김현희</p>
  </footer>


  <script src="/user/js/common.js"></script>

</body>

</html>

<!-- ui -> 9월 24일까지 완성
 spring 생성: 25일 
 docker : 26일 
 이후 -> 백엔드
 -->