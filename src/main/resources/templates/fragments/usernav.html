<nav>
    <div class="icon-bar">
        <div class="icon-top">
            <a href="/usermain">
                <i class="fa-solid fa-house"></i>
                <div class="icon-name">í™ˆ</div>
            </a>
            <a href="/userweather">
                <i class="fa-solid fa-cloud"></i>
                <div class="icon-name">ë‚ ì”¨</div>
            </a>
            <a href="/userschedule">
                <i class="fa-solid fa-calendar-days"></i>
                <div class="icon-name">ìŠ¤ì¼€ì¤„</div>
            </a>
            <a href="/usermail">
                <i class="fa-regular fa-envelope"></i>
                <div class="icon-name">ë©”ì¼</div>
            </a>
            <a href="/userboard">
                <i class="fa-solid fa-pen-to-square"></i>
                <div class="icon-name">ê²Œì‹œíŒ</div>
            </a>
            <a href="/userdoc">
                <i class="fa-regular fa-file"></i>
                <div class="icon-name">ì „ìê²°ì¬</div>
            </a>
        </div>

        <div class="icon-bottom">
            <a href="#" id="chat-view-status">+</a>

            <div id="alert-count" class="alert-wrapper">
                ğŸ””
                <span class="notification hidden">0</span>
                <div class="dropdown"></div>
            </div>

            <!-- <button id="deleteAllNotificationsBtn">ëª¨ë“  ì•Œë¦¼ ì‚­ì œ</button> -->

            <input type="hidden" id="userId" name="userId" value="{{loginUser.userPk}}">


            <script>
                // CSRF í† í°ê³¼ í—¤ë” ê°€ì ¸ì˜¤ê¸°
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

                const userId = document.getElementById('userId').value;
                const alertIcon = document.getElementById('alert-count');
                let dropdown = document.querySelector('.dropdown');
                let hideTimeout;

                // if (!dropdown) {
                //     console.log("dropdown ì—†ìŒ");
                //     return;
                // };

                // ë“œë¡­ë‹¤ìš´ ìœ„ì¹˜ ì¡°ì • + z-index
                if (dropdown) {
                    document.body.appendChild(dropdown);
                    dropdown.style.position = 'absolute';
                    dropdown.style.display = 'none';
                    dropdown.style.zIndex = 9999; // ë‹¤ë¥¸ ìš”ì†Œ ìœ„ë¡œ
                }

                // ì•Œë¦¼ ê°€ì ¸ì˜¤ê¸°
                async function loadNotifications() {
                    try {
                        const res = await fetch(`/notifications?userId=${userId}`, {
                            headers: { [csrfHeader]: csrfToken }
                        });
                        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

                        const data = await res.json();
                        const countElem = alertIcon.querySelector('.notification');
                        const unreadCount = data.filter(n => !n.read && n.read !== undefined ? n.read : !n.isRead).length;

                        // ì•Œë¦¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
                        countElem.textContent = unreadCount || '0'; // 0ìœ¼ë¡œ ì´ˆê¸°í™”

                        // ì•Œë¦¼ì´ 1ê°œ ì´ìƒ ìˆìœ¼ë©´ hidden í´ë˜ìŠ¤ ì œê±°í•˜ê³  í‘œì‹œ
                        if (unreadCount > 0) {
                            countElem.classList.remove('hidden');
                        } else {
                            countElem.classList.add('hidden');
                        }

                        dropdown.innerHTML = ''; // ê¸°ì¡´ ì•Œë¦¼ ëª©ë¡ ì´ˆê¸°í™”

                        data.forEach(noti => {
                            // if (noti.type !== 'mail' && noti.type !== 'message') return;
                            const div = document.createElement('div');
                            div.classList.add('noti-item');
                            div.dataset.id = noti.id;
                            div.style.cursor = noti.referenceId ? 'pointer' : 'default'; // referenceId ì—†ìœ¼ë©´ í´ë¦­ í‘œì‹œ X

                            // referenceId ê¸°ë°˜ URL ì„¤ì •
                            if (noti.type === 'system' && noti.referenceId) {
                                div.dataset.url = `/userboarddetail/notice/${noti.referenceId}`;
                            }
                            if (noti.type === 'mail') {
                                div.dataset.url = `/user/mail/detail/${noti.referenceId}`;
                            }

                            let timeStr = '';
                            if (noti.createdAt) {
                                const d = new Date(noti.createdAt);
                                timeStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                            }

                            div.innerHTML = `
                                <span class="msg" style="pointer-events:none;">${noti.title || noti.content}</span>
                                <span class="time" style="pointer-events:none;">${timeStr}</span>
                            `;

                            if (noti.read || noti.isRead) div.classList.add('read');

                            dropdown.appendChild(div);
                        });

                    } catch (err) {
                        console.error('ì•Œë¦¼ ë¡œë“œ ì‹¤íŒ¨:', err);
                    }
                }

                // ë“œë¡­ë‹¤ìš´ í‘œì‹œ/ìˆ¨ê¹€ (ì§€ì—°)
                alertIcon.addEventListener('mouseenter', () => {
                    clearTimeout(hideTimeout);
                    const rect = alertIcon.getBoundingClientRect();
                    dropdown.style.top = `${rect.top}px`;
                    dropdown.style.left = `${rect.right + 5}px`;
                    dropdown.style.display = 'block';
                });

                alertIcon.addEventListener('mouseleave', e => {
                    if (!dropdown.contains(e.relatedTarget)) {
                        hideTimeout = setTimeout(() => dropdown.style.display = 'none', 300);
                    }
                });

                dropdown.addEventListener('mouseenter', () => clearTimeout(hideTimeout));
                dropdown.addEventListener('mouseleave', e => {
                    if (!alertIcon.contains(e.relatedTarget)) {
                        hideTimeout = setTimeout(() => dropdown.style.display = 'none', 300);
                    }
                });

                // í´ë¦­ ì‹œ ì‚­ì œ + ë§í¬ ì´ë™
                dropdown.addEventListener('click', async e => {
                    const item = e.target.closest('.noti-item');
                    if (!item) return;

                    const notiId = item.dataset.id;
                    const url = item.dataset.url;
                    if (!url) return;

                    console.log(notiId, url);

                    try {
                        const res = await fetch(`/notifications/${notiId}`, {
                            method: 'DELETE',
                            headers: {
                                [csrfHeader]: csrfToken
                            }
                        });

                        if (res.ok) {
                            // í™”ë©´ì—ì„œ ì¦‰ì‹œ ì œê±°
                            item.remove();

                            const countElem = alertIcon.querySelector('.notification');
                            const newCount = Math.max(0, parseInt(countElem.textContent) - 1);
                            countElem.textContent = newCount;
                            if (newCount === 0) countElem.classList.add('hidden');
                        } else {
                            console.error('ì‚­ì œ ì‹¤íŒ¨:', res.status);
                        }

                        // ì‚­ì œ í›„ ì´ë™
                        window.location.href = url;

                    } catch (err) {
                        console.error('ì•Œë¦¼ ì‚­ì œ ì—ëŸ¬:', err);
                        window.location.href = url;
                    }
                });

                // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                document.addEventListener('DOMContentLoaded', loadNotifications);


                // ===========================

                // ëª¨ë“  ì•Œë¦¼ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
                // document.getElementById('deleteAllNotificationsBtn').addEventListener('click', async function () {
                //     try {
                //         const res = await fetch('/notifications/deleteAll', {
                //             method: 'DELETE',
                //             headers: {
                //                 [csrfHeader]: csrfToken,
                //             },
                //         });

                //         if (res.ok) {
                //             // ì•Œë¦¼ ëª©ë¡ì„ ê°±ì‹ í•˜ê±°ë‚˜ í™”ë©´ì—ì„œ ì•Œë¦¼ ì‚­ì œ
                //             console.log('ëª¨ë“  ì•Œë¦¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                //             dropdown.innerHTML = ''; // ë“œë¡­ë‹¤ìš´ ë‚´ìš© ë¹„ìš°ê¸°
                //             const countElem = alertIcon.querySelector('.notification');
                //             countElem.textContent = '0'; // ì•Œë¦¼ ê°œìˆ˜ ì´ˆê¸°í™”
                //             countElem.classList.add('hidden'); // ìˆ¨ê¸°ê¸°
                //         } else {
                //             console.error('ëª¨ë“  ì•Œë¦¼ ì‚­ì œ ì‹¤íŒ¨');
                //         }
                //     } catch (error) {
                //         console.error('ì•Œë¦¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                //     }
                // });


            </script>


            <a href="/user-mypage"><i class="fa-solid fa-circle-user"></i></a>
        </div>
    </div>


    <div class="chat-user">
        <h3 class="chat-header">ë¶€ì„œëª…</h3>

        <div class="chat-content">
            <div class="coworker-card">
                <span><b>ì´ë¦„</b>
                    <p>ì°¸ì—¬ì¸ì›</p>
                </span>
                <p>ìµœì¢… ëŒ€í™” ë‚´ìš©</p>
            </div>
        </div>

        <button type="submit" class="newChatroom">+</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</nav>