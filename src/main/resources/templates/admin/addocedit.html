<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" content="{{_csrf.token}}">
    <meta name="_csrf_header" content="{{_csrf.headerName}}">
    <link rel="stylesheet" href="/admin/addocedit.css">

    <title>관리자 전자결재 편집기</title>
    <script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>

</head>

<body>
    <div class="doc-view">

        <aside>
            <div class="funs-zips grid-view">
                <div class="grid-item topSec">상단정보</div>
                <div class="grid-item docSec">문서정보</div>
                <div class="grid-item approvalSec">결재</div>
                <div class="grid-item drafterSec">기안자</div>
                <div class="grid-item docDetailSec">상세문서</div>
                <div class="grid-item fileSec">파일</div>
                <div class="grid-item subTitleSec" style="background-color: #3498db;">부제목</div>
                <div class="grid-item pageNoSec">페이지번호</div>
                <div class="grid-item docDetailTitle">본문제목</div>
                <div class="grid-item docDetailContent">상세내용</div>
                <div class="grid-item docDetailNote">특기사항</div>
            </div>

            <div class="form-wrapper">
                <div class="form-title">문서 정보</div>
                <div>
                    <div class="form-group">
                        <label for="docCode">Document Code</label>
                        <input type="text" class="docMetaInfo" id="docCode" name="docCode" placeholder="문서 코드 입력(영어)">
                    </div>
                    <div class="form-group">
                        <label for="docName">Document Name</label>
                        <input type="text" class="docMetaInfo" id="docName" name="docName" placeholder="문서 이름 입력">
                    </div>
                </div>
            </div>

            <div class="btn-zip">
                <div class="actionBtn">
                    <button class="submitBtn btn">등록하기</button>
                    <button class="deleteBtn btn" onclick="handleDelete()">삭제하기</button>
                </div>
            </div>
        </aside>

        <main>
            <form action="#" method="post">
                <div class="edit-view">
                    <div class="title"><input type="text" id="getDocName" placeholder="문서 서식명(ex: 기 안 서)" readonly>
                    </div>
                    <div class="subtitle">아래와 같이 <span class="doc-title">기안서</span>를 제출합니다.</div>

                    <div class="top-info">
                        <table class="doc-info">
                            <tr>
                                <th>문서번호</th>
                                <td><input type="text" name="docNo" placeholder="docCode-JobCode-No" readonly></td>
                            </tr>
                            <tr class="page-info">
                                <th>페이지번호</th>
                                <td>
                                    <input type="text" name="pageNo" class="short" readonly> /
                                    <input type="text" name="pageTotal" class="short" readonly> Page
                                </td>
                            </tr>
                            <tr>
                                <th>작성자</th>
                                <td><input type="text" name="writer" readonly></td>
                            </tr>
                            <tr>
                                <th>작성일자</th>
                                <td><input type="date" name="writeDate" style="width: 120px;" readonly></td>
                            </tr>
                        </table>

                        <table class="approval-line">
                            <tr>
                                <th rowspan="3" class="approval-label">결재</th>
                                <th>본부장</th>
                                <th>대표이사</th>
                            </tr>
                            <tr class="sign-row">
                                <td id="teamLeaderStamp"></td>
                                <td id="ceoStamp"></td>
                            </tr>
                            <tr>
                                <td>/</td>
                                <td>/</td>
                            </tr>
                        </table>
                    </div>

                    <!-- 상세 문서 테이블 -->
                    <table>
                        <!-- 기안자 -->
                        <tr class="drafter-info">
                            <th rowspan="2">기안자</th>
                            <th>사번</th>
                            <td><input type="text" readonly></td>
                            <th>소속</th>
                            <td><input type="text" readonly></td>
                        </tr>
                        <tr class="drafter-info">
                            <th>직급</th>
                            <td><input type="text" readonly></td>
                            <th>성명</th>
                            <td><input type="text" readonly></td>
                        </tr>
                        <tr class="drafter-info">
                            <th>기안일자</th>
                            <td colspan="4"><input type="date" readonly></td>
                        </tr>

                        <!-- 상세문서 영역 -->
                        <tbody class="doc-detail-info">
                            <tr class="title-row">
                                <th>제목</th>
                                <td colspan="4"><input type="text" class="doc-detail-title" readonly></td>
                            </tr>
                            <tr class="content-row">
                                <th>상세내용</th>
                                <td colspan="4">
                                    <div id="editor" class="content-area"></div>
                                </td>
                            </tr>
                            <tr class="note-row">
                                <th>특기사항</th>
                                <td colspan="4"><textarea class="doc-detail-notes" readonly></textarea></td>
                            </tr>
                        </tbody>

                        <!-- 파일 -->
                        <tr class="file-info">
                            <th>첨부목록</th>
                            <td colspan="4"><input type="file" readonly></td>
                        </tr>
                    </table>

                </div>
            </form>
        </main>
    </div>

    <script>
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        document.addEventListener("DOMContentLoaded", () => {

            // 좌측 메뉴 토글
            const toggle = (el, style = "display") => {
                if (!el) return;
                if (style === "visibility") {
                    el.style.visibility = (el.style.visibility === "hidden") ? "visible" : "hidden";
                } else {
                    el.style.display = (el.style.display === "none" || window.getComputedStyle(el).display === "none") ? "" : "none";
                }
            };

            const toggleMap = [
                { btn: ".topSec", target: ".top-info" },
                { btn: ".docSec", target: ".doc-info" },
                { btn: ".approvalSec", target: ".approval-line" },
                { btn: ".drafterSec", target: ".drafter-info", all: true },
                { btn: ".docDetailSec", target: ".doc-detail-info", all: true },
                { btn: ".fileSec", target: ".file-info" },
                { btn: ".subTitleSec", target: ".subtitle", style: "visibility" },
                { btn: ".pageNoSec", target: ".page-info" },
                { btn: ".docDetailTitle", target: ".title-row" },
                { btn: ".docDetailContent", target: ".content-row" },
                { btn: ".docDetailNote", target: ".note-row" }
            ];

            toggleMap.forEach(({ btn, target, all, style }) => {
                const button = document.querySelector(btn);
                if (!button) return;

                button.addEventListener("click", () => {
                    const elements = all ? document.querySelectorAll(target) : [document.querySelector(target)];
                    elements.forEach(el => toggle(el, style));
                });
            });

            // 문서 제목 실시간 반영
            const docNameInput = document.getElementById("docName");
            const getDocNameInput = document.getElementById("getDocName");
            const docTitleSpan = document.querySelector(".doc-title");

            docNameInput.addEventListener("input", () => {
                const value = docNameInput.value;
                getDocNameInput.value = value;
                if (docTitleSpan) docTitleSpan.textContent = value;
            });

            // 화면 표시 여부 체크
            const isVisible = (selector) => {
                const el = document.querySelector(selector);
                if (!el) return false;
                return window.getComputedStyle(el).display !== "none";
            };

            // 등록 버튼
            const submitBtn = document.querySelector(".submitBtn");
            submitBtn.addEventListener("click", async (e) => {
                e.preventDefault();

                const docCode = document.getElementById("docCode").value.trim();
                const docName = document.getElementById("docName").value.trim();

                if (!docCode || !docName) {
                    alert("문서 코드와 문서 이름을 입력하세요.");
                    return;
                }

                const body = {
                    docCode,
                    docName,
                    deptCode: 1,
                    useDocNo: isVisible(".doc-info"),
                    usePageNo: isVisible(".page-info"),
                    useWriter: isVisible("input[name='writer']"),
                    useApproval: isVisible(".approval-line"),
                    useDrafter: isVisible(".drafter-info"),
                    useDetailTitle: isVisible(".title-row"),
                    useDetailContent: isVisible(".content-row"),
                    useDetailNote: isVisible(".note-row"),
                    useFile: isVisible(".file-info")
                };

                // 화면에 body 내용 출력 (디버그용)
                console.log("전송할 body:", body);
                alert(JSON.stringify(body, null, 2));

                try {
                    const res = await fetch("/doc/create", {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json",
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify(body)
                    });

                    const result = await res.json();
                    alert(result.message);
                    if (result.success) location.href = "/adapprovallist";

                } catch (err) {
                    console.error(err);
                    alert("서버 통신 중 오류가 발생했습니다.");
                }
            });

            // 삭제 버튼
            window.handleDelete = () => {
                if (confirm("정말 삭제하시겠습니까?")) {
                    alert("삭제되었습니다.");
                    location.href = "/adapprovallist";
                }
            };

            // CKEditor
            ClassicEditor.create(document.querySelector('#editor'), {
                toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote']
            }).then(editor => {
                editor.ui.view.editable.element.style.minHeight = "600px";
            }).catch(console.error);
        });
    </script>


</body>

</html>

<!-- 
기안일자 |	문서를 **처음으로 기안(초안 작성)**한 날짜.
작성일자 |	문서를 작성 완료한 날짜. 또는 실제로 문서에 작성된 날짜를 표기한 것.
-->